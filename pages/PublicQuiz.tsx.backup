import React, { useState, useEffect } from 'react';
import { useParams } from 'react-router-dom';
import { supabase } from '../lib/supabase';
import { useTheme } from '../context/ThemeContext';
import PixelButton from '../components/ui/PixelButton';
import PixelCard from '../components/ui/PixelCard';

interface Quiz {
    id: string;
    title: string;
    description: string;
}

interface Question {
    id: string;
    text: string;
    type: 'multiple_choice' | 'short_text';
    order: number;
    options: Option[];
}

interface Option {
                .select('*')
                .eq('id', quizId)
                .eq('is_published', true)
                .single();

            console.log('Quiz data:', quizData);
console.log('Quiz error:', error);

if (error || !quizData) {
    console.error('Quiz not found or not published');
    setLoading(false);
    return;
}

setQuiz(quizData);

const { data: questionsData } = await supabase
    .from('quiz_questions')
    .select('*, options:quiz_options(*)')
    .eq('quiz_id', quizId)
    .order('order');

console.log('Questions data:', questionsData);

if (questionsData) {
    setQuestions(questionsData.map((q: any) => ({
        ...q,
        options: q.options?.sort((a: any, b: any) => a.text.localeCompare(b.text))
    })));
}
        } catch (error) {
    console.error('Error loading quiz:', error);
} finally {
    setLoading(false);
}
    };

const handleOptionSelect = (questionId: string, optionId: string, points: number) => {
    setAnswers(prev => ({
        ...prev,
        [questionId]: { optionId, points }
    }));
    if (ans.points) totalScore += ans.points;
});

try {
    // Determinar temperatura do lead
    let leadStatus = 'Frio';
    if (totalScore >= 61) leadStatus = 'Quente';
    else if (totalScore >= 31) leadStatus = 'Morno';

    // 1. Criar contato
    const { data: contact, error: contactError } = await supabase
        .from('contacts')
        .insert([{
            name: respondent.name,
            email: respondent.email,
            phone: respondent.whatsapp,
            status: leadStatus,
            score: totalScore,
            created_at: new Date().toISOString()
        }])
        .select()
        .single();

    if (contactError) throw contactError;

    // 2. Criar deal no pipeline (coluna "Novos Leads")
    const { error: dealError } = await supabase
        .from('deals')
        .insert([{
            title: `${respondent.name} - Quiz: ${quiz.title}`,
            contact_id: contact.id,
            value: 0,
            status: 'Novos Leads',
            created_at: new Date().toISOString()
        }]);

    if (dealError) throw dealError;

    // 3. Criar resposta do quiz vinculada ao contato
    const { data: response, error: responseError } = await supabase
        .from('quiz_responses')
        .insert([{
            quiz_id: quiz.id,
            contact_id: contact.id,
            respondent_name: respondent.name,
            respondent_email: respondent.email,
            respondent_whatsapp: respondent.whatsapp,
            total_score: totalScore,
            created_at: new Date().toISOString()
        }])
        .select()
        .single();

    if (responseError) throw responseError;

    // 4. Criar respostas individuais
    const answersToInsert = Object.entries(answers).map(([questionId, ans]: [string, any]) => ({
        response_id: response.id,
        question_id: questionId,
        option_id: ans.optionId || null,
        text_value: ans.text || null
    }));

    if (answersToInsert.length > 0) {
        await supabase.from('quiz_answers').insert(answersToInsert);
    }

    setScore(totalScore);
    setSubmitted(true);
} catch (error) {
    console.error('Error submitting quiz:', error);
    alert('Erro ao enviar respostas.');
}
};

const getTemperature = (score: number) => {
    if (score >= 61) return { label: 'QUENTE', color: 'text-retro-red', bg: 'bg-retro-red' };
    if (score >= 31) return { label: 'MORNO', color: 'text-retro-yellow', bg: 'bg-retro-yellow' };
    return { label: 'FRIO', color: 'text-retro-cyan', bg: 'bg-retro-cyan' };
};

if (loading) return <div className="min-h-screen bg-retro-bg flex items-center justify-center text-retro-fg font-header">Carregando...</div>;
if (!quiz) return <div className="min-h-screen bg-retro-bg flex items-center justify-center text-retro-fg font-header">Quiz não encontrado ou não publicado.</div>;

if (submitted) {
    return (
        <div className="min-h-screen bg-retro-bg p-8 flex items-center justify-center">
            <div className="max-w-2xl w-full">
                <PixelCard title="Obrigado!">
                    <div className="text-center space-y-6 py-8">
                        <h2 className="font-header text-3xl text-retro-green mb-6">✓ Respostas Enviadas!</h2>

                        <div className="bg-retro-surface border-2 border-black p-6">
                            <p className="text-retro-fg text-lg leading-relaxed">
                                Nossa equipe está analisando as suas respostas e em breve entrará em contato.
                            </p>
                            <p className="text-retro-fg text-lg leading-relaxed mt-4">
                                Obrigado por entrar em contato com a <strong className="text-retro-cyan">{agencyName}</strong>!
                            </p>
                        </div>
                    </div>
                </PixelCard>
            </div>
        </div>
    );
}

return (
    <div className="min-h-screen bg-retro-bg p-4 md:p-8 overflow-y-auto">
        <div className="max-w-3xl mx-auto space-y-8">
            <div className="text-center mb-12">
                <h1 className="font-header text-4xl text-retro-fg mb-4 text-shadow-retro">{quiz.title}</h1>
                <p className="text-retro-comment text-xl">{quiz.description || 'Responda as perguntas abaixo para avaliarmos seu perfil.'}</p>
            </div>

            <form onSubmit={handleSubmit} className="space-y-8">
                <PixelCard title="Seus Dados">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div className="space-y-2">
                            <label className="block text-retro-comment uppercase text-sm font-bold">Nome Completo</label>
                            <input
                                type="text"
                                required
                                value={respondent.name}
                                onChange={e => setRespondent({ ...respondent, name: e.target.value })}
                                className="w-full bg-retro-bg border-2 border-black p-3 text-retro-fg focus:border-retro-cyan outline-none"
                            />
                        </div>
                        <div className="space-y-2">
                            <label className="block text-retro-comment uppercase text-sm font-bold">Email</label>
                            <input
                                type="email"
                                required
                                value={respondent.email}
                                onChange={e => setRespondent({ ...respondent, email: e.target.value })}
                                className="w-full bg-retro-bg border-2 border-black p-3 text-retro-fg focus:border-retro-cyan outline-none"
                            />
                        </div>
                        <div className="space-y-2 md:col-span-2">
                            <label className="block text-retro-comment uppercase text-sm font-bold">WhatsApp</label>
                            <input
                                type="tel"
                                required
                                value={respondent.whatsapp}
                                onChange={e => setRespondent({ ...respondent, whatsapp: e.target.value })}
                                placeholder="(11) 99999-9999"
                                className="w-full bg-retro-bg border-2 border-black p-3 text-retro-fg focus:border-retro-cyan outline-none"
                            />
                        </div>
                    </div>
                </PixelCard>

                {questions.map((q, idx) => (
                    <PixelCard key={q.id} title={`${idx + 1}. ${q.text}`}>
                        <div className="space-y-4">
                            {q.type === 'multiple_choice' ? (
                                <div className="space-y-2">
                                    {q.options?.map((opt) => (
                                        <label
                                            key={opt.id}
                                            className={`flex items-center gap-4 p-4 border-2 cursor-pointer transition-all ${answers[q.id]?.optionId === opt.id
                                                ? 'bg-retro-cyan/20 border-retro-cyan'
                                                : 'bg-retro-bg border-black hover:bg-retro-surface'
                                                }`}
                                        >
                                            <input
                                                type="radio"
                                                name={q.id}
                                                value={opt.id}
                                                required
                                                onChange={() => handleOptionSelect(q.id, opt.id, opt.points)}
                                                className="w-5 h-5 accent-retro-cyan"
                                            />
                                            <span className="text-lg text-retro-fg">{opt.text}</span>
                                        </label>
                                    ))}
                                </div>
                            ) : (
                                <textarea
                                    rows={3}
                                    required
                                    onChange={(e) => handleTextChange(q.id, e.target.value)}
                                    className="w-full bg-retro-bg border-2 border-black p-4 text-retro-fg focus:border-retro-cyan outline-none resize-none"
                                    placeholder="Digite sua resposta..."
                                />
                            )}
                        </div>
                    </PixelCard>
                ))}

                <div className="flex justify-center pt-8 pb-20">
                    <PixelButton variant="primary" type="submit" className="text-xl px-12 py-4">
                        ENVIAR RESPOSTAS
                    </PixelButton>
                </div>
            </form>
        </div>
    </div>
);
};

export default PublicQuiz;
